// ==UserScript==
// @name         EBYS Plus
// @namespace    https://github.com/tkgmplus/EBYS
// @version      25.73
// @description  GitHub'dan gÃ¼ncellemeleri kontrol eden ve yÃ¼kleyen sistem
// @author       Sen
// @match        https://ebys.tkgm.gov.tr/edys-web/sistemeGiris.xhtml
// @match        https://ebys.tkgm.gov.tr/edys-web/mainInbox.xhtml*
// @grant        GM_xmlhttpRequest
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_notification
// @grant        GM_addStyle
// ==/UserScript==


(function () {
    "use strict";

    // ğŸ“Œ GÃ¼ncelleme dosyalarÄ±nÄ±n URL'leri
    const VERSION_URL = "https://raw.githubusercontent.com/tkgmplus/EBYS/main/Version.txt"; // Versiyon ve ve Ã¶zelikler Ã§ekiliyor
    const SCRIPT_URL = "https://raw.githubusercontent.com/tkgmplus/EBYS/main/EBYS_Plus.txt"; // Guncell Dosya indiriliyor

    // ğŸ“Œ Son gÃ¼ncelleme kontrol zamanÄ± ve kayÄ±tlÄ± sÃ¼rÃ¼mÃ¼ al
    let lastCheck = GM_getValue("lastCheck", 0);
    
    let savedVersion = GM_getValue("scriptVersion", "0.0.0");


    /**
     * ğŸ“Œ GitHub'dan gÃ¼ncelleme olup olmadÄ±ÄŸÄ±nÄ± kontrol eder.
     * @param {boolean} manual - EÄŸer kullanÄ±cÄ± manuel kontrol ettiyse true olur.
     */
    function checkForUpdate(manual = false) {
        let now = Date.now();

        // Otomatik kontrolde, 15 gÃ¼nden Ã¶nce tekrar kontrol etmeye gerek yok.
        if (!manual && now - lastCheck < 15 * 24 * 60 * 60 * 1000) {
            console.log("GÃ¼ncelleme kontrolÃ¼ yapÄ±lmadÄ± (15 gÃ¼n geÃ§medi).");
            return;
        }

        // GitHub'dan version.txt dosyasÄ±nÄ± Ã§ek
        GM_xmlhttpRequest({
            method: "GET",
            url: VERSION_URL,
            onload: function (response) {
                if (response.status === 200) {
                    let data = response.responseText.split("\n");
                    let newVersion = data[0].trim(); // Ä°lk satÄ±r sÃ¼rÃ¼m numarasÄ±
                    let changelog = data.slice(1).join("<br>"); // Geri kalan gÃ¼ncelleme notlarÄ±




if (newVersion > savedVersion) {
    showUpdateNotification(newVersion, changelog);// Sol Alt KÃ¶ÅŸe GÃœncelleme EkranÄ±nÄ± AÃ§
} else {
    if (manual) {
        showCurrentVersionPopup();// GÃœncelsiniz Bildirimi
    }
}



// ***********************  GÃ¼ncelsiniz Popup BAÅ  ************************
function showCurrentVersionPopup() {
    // Ã–nce varsa eski bildirimi kaldÄ±r
    let existingPopup = document.getElementById("currentVersionPopup");
    if (existingPopup) existingPopup.remove();

    // Yeni pencere oluÅŸtur
    let popup = document.createElement("div");
    popup.id = "currentVersionPopup";
    popup.innerHTML = `
        <div class="version-container">
            <h2>âœ… GÃ¼ncel SÃ¼rÃ¼m KullanÄ±yorsunuz!</h2>
            <p>Åu anda en son sÃ¼rÃ¼mÃ¼ kullanÄ±yorsunuz. GÃ¼ncelleme gerekmiyor.</p>
            <button id="closeVersionPopup">Kapat</button>
        </div>
    `;

    document.body.appendChild(popup);

    // Kapatma butonu
    document.getElementById("closeVersionPopup").addEventListener("click", () => {
        popup.classList.remove("show");
        setTimeout(() => popup.remove(), 300);
    });

    // Animasyon ekleyelim
    setTimeout(() => popup.classList.add("show"), 50);

    // Stil ekleme
    GM_addStyle(`
        #currentVersionPopup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(30, 30, 30, 0.95);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 300px;
            max-width: 90%;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 9999;
        }

        #currentVersionPopup.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .version-container h2 {
            margin: 0 0 10px;
            font-size: 18px;
        }

        .version-container p {
            font-size: 14px;
            margin-bottom: 15px;
        }

        #closeVersionPopup {
            padding: 8px 12px;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.2s ease;
        }

        #closeVersionPopup:hover {
            background: #0056b3;
        }
    `);
}

// ***********************  GÃ¼ncelsiniz Popup SON ************************

                }
            }
        });

        // Kontrol zamanÄ±nÄ± kaydet
        GM_setValue("lastCheck", now);
    }





    /**
     * ğŸ“Œ SaÄŸ Ã¼st kÃ¶ÅŸeye manuel gÃ¼ncelleme kontrol butonu ekler.
     */
    function addManualCheckButton() {
        // EÄŸer buton zaten varsa tekrar ekleme
        if (document.getElementById("manualUpdateButton")) return;

        let manualButton = document.createElement("button");
        manualButton.innerText = "ğŸ” GÃ¼ncellemeyi Kontrol Et";
        manualButton.id = "manualUpdateButton";
        document.body.appendChild(manualButton);

        manualButton.addEventListener("click", () => checkForUpdate(true));

        GM_addStyle(`
            #manualUpdateButton {
                position: fixed;
                top: 10px;
                right: 10px;
                z-index: 1000;
                padding: 8px 12px;
                background: #28a745;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
                transition: all 0.3s ease;
            }
            #manualUpdateButton:hover {
                background: #218838;
            }
        `);
    }

    /**
     * ğŸ“Œ GÃ¼ncelleme bildirimi ekranÄ± oluÅŸturur.
     * @param {string} newVersion - Yeni sÃ¼rÃ¼m numarasÄ±
     * @param {string} changelog - GÃ¼ncelleme notlarÄ±
     */
function showUpdateNotification(newVersion, changelog) {
    // ğŸ“Œ EÄŸer daha Ã¶nce aÃ§Ä±lmÄ±ÅŸ bir gÃ¼ncelleme penceresi varsa, Ã¶nce onu kaldÄ±r
    let existingPopup = document.getElementById("updatePopup");
    if (existingPopup) existingPopup.remove();

    // ğŸ“Œ Yeni gÃ¼ncelleme bildirim penceresini oluÅŸtur
    let updateDiv = document.createElement("div");
    updateDiv.id = "updatePopup";
    updateDiv.innerHTML = `
        <div class="update-container">
            <h3>ğŸ”„ Yeni GÃ¼ncelleme Mevcut (${newVersion})</h3>
            <p class="changelog">${changelog}</p>
            <div class="button-group">
                <button id="updateNow">ğŸ”„ GÃ¼ncelle</button>
                <button id="ignoreUpdate">âŒ VazgeÃ§</button>
            </div>
        </div>
    `;

    // ğŸ“Œ Sayfaya gÃ¼ncelleme penceresini ekle
    document.body.appendChild(updateDiv);

    // ğŸ“Œ Butonlara tÄ±klanÄ±nca Ã§alÄ±ÅŸacak olaylarÄ± tanÄ±mla
    document.getElementById("updateNow").addEventListener("click", updateScript);  // GÃ¼ncelleme butonu
    document.getElementById("ignoreUpdate").addEventListener("click", () => updateDiv.remove());  // Kapatma butonu

    // ğŸ“Œ TarayÄ±cÄ± bildirimini gÃ¶ster
    GM_notification({
        text: ` ğŸ”„ Mevcut SÃ¼rÃ¼m: ${savedVersion}\n âœ¨ Yeni SÃ¼rÃ¼m: ${newVersion}\n\n ğŸš€ GÃ¼ncellemek iÃ§in tÄ±klayÄ±n!`,
        title: "ğŸ”” EBYS PLUS GÃ¼ncelleme \n ---------------------------------------------------------",
        highlight: true,
        timeout: 20000
    });


    // ğŸ“Œ GÃ¼ncelleme penceresinin stilini belirle
    GM_addStyle(`
        /* ğŸ“Œ GÃ¼ncelleme bildirim penceresinin konumu ve temel stilleri */
        #updatePopup {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(30, 30, 30, 0.95);
            color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
            width: 320px;
            max-width: 90%;
            transition: transform 0.3s ease, opacity 0.3s ease;
            transform: translateY(100px);
            opacity: 0;
            z-index: 9999;
        }

        /* ğŸ“Œ AÃ§Ä±lma efekti */
        #updatePopup.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* ğŸ“Œ BaÅŸlÄ±k stilleri */
        .update-container h3 {
            margin: 0 0 10px;
            font-size: 16px;
        }

        /* ğŸ“Œ GÃ¼ncelleme notlarÄ±nÄ±n gÃ¶rÃ¼nÃ¼mÃ¼ */
        .update-container .changelog {
            font-size: 14px;
            max-height: 120px;
            overflow-y: auto;
            padding: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin-bottom: 10px;
        }

        /* ğŸ“Œ ButonlarÄ± hizalama */
        .button-group {
            display: flex;
            justify-content: space-between;
        }

        /* ğŸ“Œ ButonlarÄ±n genel stili */
        .button-group button {
            padding: 7px 12px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
            transition: background 0.2s ease;
        }

        /* ğŸ“Œ GÃ¼ncelleme butonu */
        #updateNow {
            background: #007bff;
            color: white;
        }
        #updateNow:hover {
            background: #0056b3;
        }

        /* ğŸ“Œ VazgeÃ§ butonu */
        #ignoreUpdate {
            background: #dc3545;
            color: white;
        }
        #ignoreUpdate:hover {
            background: #a71d2a;
        }
    `);

    // ğŸ“Œ Bildirimin gÃ¶rÃ¼nmesini saÄŸlayan animasyonu baÅŸlat (0.1 saniye gecikmeyle)
    setTimeout(() => updateDiv.classList.add("show"), 100);
}

    /**
     * ğŸ“Œ GÃ¼ncellemeyi indirip uygulayan fonksiyon
     */
    function updateScript() {
        GM_xmlhttpRequest({
            method: "GET",
            url: SCRIPT_URL,
            onload: function (response) {
                if (response.status === 200) {
                    GM_setValue("savedScript", response.responseText);
                    GM_setValue("scriptVersion", response.responseText.match(/@version\s+([\d.]+)/)?.[1] || "0.0.0");



                    // GitHub'dan version.txt dosyasÄ±nÄ± Ã§ek
                    GM_xmlhttpRequest({
                        method: "GET",
                        url: VERSION_URL,
                        onload: function (response) {
                            if (response.status === 200) {
                                let data = response.responseText.split("\n");
                                let newVersion = data[0].trim(); // Ä°lk satÄ±r sÃ¼rÃ¼m numarasÄ±
                                GM_setValue("scriptVersion", newVersion); // Yeni sÃ¼rÃ¼mÃ¼ kaydet
                            }}})

                    showConfetti();
                    showToast("ğŸ‰ Yeni sÃ¼rÃ¼m yÃ¼klendi! Sayfa 3 saniye iÃ§inde yenilenecek.", "success");

                    setTimeout(() => {
                        location.reload();
                    }, 3000);
                }
            }
        });
    }

    /**
     * ğŸ“Œ SaÄŸ alt kÃ¶ÅŸede bilgilendirme mesajÄ± gÃ¶sterir.
     * @param {string} message - GÃ¶sterilecek mesaj
     * @param {string} type - Mesaj tipi (info, success, error vb.)
     */
    function showToast(message, type = "info") {
        let toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.innerText = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    /**
     * ğŸ“Œ Konfeti animasyonu oynatÄ±r.
     */
    function showConfetti() {
        let confettiScript = document.createElement("script");
        confettiScript.src = "https://cdn.jsdelivr.net/npm/canvas-confetti@1.3.1";
        document.head.appendChild(confettiScript);
        confettiScript.onload = () => {
            let duration = 3 * 1000;
            let end = Date.now() + duration;

            (function frame() {
                confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
                confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });

                if (Date.now() < end) requestAnimationFrame(frame);
            })();
        };
    }

    // ğŸ“Œ KayÄ±tlÄ± betiÄŸi Ã§alÄ±ÅŸtÄ±r (Ã¶nceki gÃ¼ncelleme sonrasÄ±)
    function injectSavedScript() {
        let savedScript = GM_getValue("savedScript", null);
        if (savedScript) eval(savedScript);
    }

    // ğŸ“Œ Script Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda gerekli fonksiyonlarÄ± Ã§aÄŸÄ±r
    injectSavedScript();
    addManualCheckButton();
    setTimeout(() => checkForUpdate(false), 1000);
})();


